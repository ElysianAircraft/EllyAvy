# Powertrain Mapping Framework

This framework provides utilities for generating powertrain mapping files that describe the performance characteristics of hybrid-electric propulsion systems across different operating conditions.

## Overview

The `PowertrainMapper` class generates CSV files that map operating conditions (Mach number, altitude, throttle settings) to powertrain performance parameters (thrust, drag, fuel flow, NOx rate, electric power). These files are compatible with Aviary's engine deck system.

## Files

- `powertrain_mapping.py` - Main framework with the `PowertrainMapper` class
- `example_powertrain_generator.py` - Example script showing how to use the framework
- `README_powertrain_mapping.md` - This documentation file

## Quick Start

### Basic Usage

```python
from aviary.subsystems.propulsion.powertrain_mapping import PowertrainMapper

# Define operating conditions
mach_numbers = [0.0, 0.3, 0.6, 0.9]
altitudes = [0.0, 10000.0, 20000.0, 37000.0, 39000.0]  # ft
throttle_settings = [21.0, 22.0, 24.0, 26.0, 30.0, 34.0, 38.0, 42.0, 46.0, 48.0, 50.0]

# Create mapper
mapper = PowertrainMapper(
    mach_numbers=mach_numbers,
    altitudes=altitudes,
    throttle_settings=throttle_settings
)

# Define your performance functions
def my_thrust_function(mach, altitude_ft, throttle):
    # Your thrust calculation logic here
    return thrust_value

def my_drag_function(mach, altitude_ft, throttle):
    # Your ram drag calculation logic here
    return drag_value

def my_fuel_flow_function(mach, altitude_ft, throttle):
    # Your fuel flow calculation logic here
    return fuel_flow_value

def my_nox_rate_function(mach, altitude_ft, throttle):
    # Your NOx rate calculation logic here
    return nox_rate_value

def my_electric_power_function(mach, altitude_ft, throttle):
    # Your electric power calculation logic here
    return electric_power_value

# Generate the mapping file
mapper.generate_mapping_file(
    output_file='my_powertrain.csv',
    thrust_function=my_thrust_function,
    drag_function=my_drag_function,
    fuel_flow_function=my_fuel_flow_function,
    nox_rate_function=my_nox_rate_function,
    electric_power_function=my_electric_power_function,
    description="My custom powertrain mapping file",
    author="My Name"
)
```

### Running the Example

```bash
cd aviary/subsystems/propulsion
python example_powertrain_generator.py
```

This will generate two example files:
- `realistic_hybrid_turbofan.csv` - Realistic hybrid turbofan with 308 data points
- `custom_high_speed_powertrain.csv` - Custom high-speed powertrain with 360 data points

## Performance Function Requirements

Each performance function must accept three parameters:
- `mach` (float): Mach number
- `altitude_ft` (float): Altitude in feet
- `throttle` (float): Throttle setting (typically 0-100)

And return the appropriate performance parameter:

### Required Functions

1. **thrust_function** → Returns gross thrust in lbf
2. **drag_function** → Returns ram drag in lbf
3. **fuel_flow_function** → Returns fuel flow in lb/h
4. **nox_rate_function** → Returns NOx rate in lb/h
5. **electric_power_function** → Returns electric power in kW

## Output File Format

The generated CSV files follow the same format as Aviary engine deck files:

```csv
# created MM/DD/YY
# Description of the powertrain mapping file
# generated by Author using PowertrainMapper
# NOTE: this powertrain is for example/testing purposes only

Mach_Number, Altitude (ft),   Throttle, Gross_Thrust (lbf), Ram_Drag (lbf), Fuel_Flow (lb/h), NOx_Rate (lb/h), Electric_Power (kW)
      0.0,         0.0,     21.0,          5880.0,           0.0,         769.9,      2.6460,          63.000
      0.0,         0.0,     22.0,          6160.0,           0.0,         825.5,      2.9040,          66.000
      ...
```

## Integration with Aviary

The generated powertrain mapping files can be used directly with Aviary's engine deck system by specifying the file path in your aircraft configuration:

```python
# In your aircraft configuration file
aircraft:engine:data_file,path/to/your/powertrain.csv,unitless
```

## Advanced Usage

### Custom Operating Conditions

You can define any combination of operating conditions:

```python
# High-speed aircraft with extended Mach range
mach_numbers = [0.0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2]
altitudes = [0.0, 10000.0, 20000.0, 30000.0, 40000.0, 50000.0]
throttle_settings = [10.0, 20.0, 30.0, 40.0, 50.0, 60.0, 70.0, 80.0, 90.0, 100.0]
```

### Realistic Performance Functions

The example script includes realistic performance functions that account for:
- **Thrust**: Decreases with Mach number (compressibility) and altitude (air density)
- **Ram Drag**: Increases with Mach squared, decreases with altitude
- **Fuel Flow**: Increases with throttle, Mach, and altitude
- **NOx Rate**: Increases with throttle and altitude
- **Electric Power**: Varies with operating conditions for hybrid systems

### Validation

You can validate your generated files by:
1. Checking the file format matches the expected structure
2. Verifying the data ranges are reasonable for your application
3. Testing the file with Aviary's engine deck system

## Tips for Creating Realistic Performance Functions

1. **Thrust Functions**: Consider compressibility effects at high Mach and air density effects at altitude
2. **Drag Functions**: Ram drag typically scales with Mach squared
3. **Fuel Flow Functions**: Usually increases with throttle and may have Mach/altitude dependencies
4. **NOx Functions**: Often increase with throttle and altitude
5. **Electric Power Functions**: For hybrid systems, consider auxiliary power needs and efficiency variations

## Troubleshooting

### Common Issues

1. **File Format Errors**: Ensure your performance functions return numeric values
2. **Memory Issues**: Large operating condition matrices can generate very large files
3. **Performance**: Consider the computational cost of your performance functions for large datasets

### Performance Optimization

For large datasets, consider:
- Using vectorized NumPy operations in your performance functions
- Generating files in chunks if memory is limited
- Optimizing your performance function calculations

## Contributing

To extend the framework:
1. Add new performance parameters by modifying the CSV header and function requirements
2. Add validation functions to check data ranges
3. Add interpolation utilities for sparse datasets
4. Add visualization tools for generated data

## License

This framework is part of the Aviary project and follows the same licensing terms.
